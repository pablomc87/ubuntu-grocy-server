#!/bin/bash

# Grocy Backup Script
# This script creates a backup of the Grocy data directory

set -e

# Configuration
BACKUP_DIR="{{ grocy_data_path }}/backups"
DATA_DIR="{{ grocy_data_path }}"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="grocy_backup_${DATE}.tar.gz"

# Create backup directory if it doesn't exist
mkdir -p "$BACKUP_DIR"

# Create backup
echo "Creating backup of Grocy data..."
tar -czf "$BACKUP_DIR/$BACKUP_FILE" -C "$(dirname "$DATA_DIR")" "$(basename "$DATA_DIR")"

echo "Backup created: $BACKUP_DIR/$BACKUP_FILE"

# Keep only the last 7 backups
echo "Cleaning up old backups..."
cd "$BACKUP_DIR"
ls -t grocy_backup_*.tar.gz | tail -n +8 | xargs -r rm

echo "Backup completed successfully!"
